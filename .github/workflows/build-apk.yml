name: Build APK with Docker

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Buildozer global directory
      uses: actions/cache@v4
      with:
        path: /tmp/.buildozer_global
        key: buildozer-global-${{ hashFiles('buildozer.spec') }}

    - name: Build with Buildozer Docker image
      run: |
        # Создаем директорию для кэша, если её нет
        mkdir -p /tmp/.buildozer_global

        # Запускаем Buildozer в Docker контейнере
        docker run --rm \
          --volume "$PWD":/home/user/hostcwd \
          --volume "/tmp/.buildozer_global":/home/user/.buildozer \
          --workdir /home/user/hostcwd \
          kivy/buildozer:latest android debug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-apk
        path: bin/*.apk
