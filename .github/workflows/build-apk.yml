name: Build APK - Final Working Version

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Cache Android SDK
      uses: actions/cache@v4
      with:
        path: |
          $HOME/.android
          $HOME/android-sdk
        key: ${{ runner.os }}-android-sdk-2-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-android-sdk-2-
    
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          git zip unzip openjdk-17-jdk python3 python3-dev python3-pip autoconf libtool pkg-config \
          libssl-dev libffi-dev libbz2-dev libsqlite3-dev libncurses5-dev libncursesw5-dev zlib1g-dev \
          libreadline-dev liblzma-dev libxml2-dev libxslt1-dev ffmpeg libsdl2-dev libsdl2-image-dev \
          libsdl2-mixer-dev libsdl2-ttf-dev libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          libjpeg-dev libpng-dev libgles2-mesa-dev patchelf libc++-dev libc++abi-dev build-essential \
          software-properties-common libncurses-dev lib32z1 curl
        
        pip3 install --upgrade pip
        pip3 install "buildozer==1.5.0" "cython==0.29.33" "kivy==2.1.0" "kivymd==1.1.1" "pillow==9.5.0"
    
    - name: Create buildozer.spec
      run: |
        cat > buildozer.spec <<EOF
[app]
title = Ceiling Calculator
package.name = ceiling_calculator
package.domain = org.test
source.dir = .
source.include_exts = py,png,jpg,kv,ttf,db
version = 0.1
requirements = python3,kivy==2.1.0,kivymd==1.1.1,sqlite3,android,pillow==9.5.0
orientation = portrait
android.permissions = INTERNET,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE,ACCESS_NETWORK_STATE
android.arch = arm64-v8a
android.api = 31
android.minapi = 21
android.ndk = 25b
android.sdk = 31
android.gradle_dependencies = 'com.google.android.material:material:1.8.0'
android.enable_androidx = True
p4a.branch = master

[buildozer]
log_level = 2
warn_on_root = 1
EOF
    
    - name: Pre-configure SDK
      run: |
        mkdir -p $HOME/.android
        echo "count=0" > $HOME/.android/repositories.cfg
        
        # Создаем директорию для SDK
        mkdir -p $HOME/android-sdk
        export ANDROID_HOME=$HOME/android-sdk
        
        # Скачиваем командную строку SDK
        wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip -d $ANDROID_HOME
        mkdir -p $ANDROID_HOME/cmdline-tools
        mv $ANDROID_HOME/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
        
        # Принимаем лицензии вручную
        mkdir -p $ANDROID_HOME/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_HOME/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_HOME/licenses/android-sdk-preview-license
        
        # Устанавливаем необходимые компоненты
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
        
        yes | sdkmanager --licenses >/dev/null 2>&1
        sdkmanager "platform-tools" "platforms;android-31" "build-tools;31.0.0" "ndk;25.1.8937393" "cmake;3.22.1" >/dev/null 2>&1
    
    - name: Build APK with retries
      env:
        ANDROID_HOME: $HOME/android-sdk
        PATH: $PATH:$HOME/android-sdk/cmdline-tools/latest/bin:$HOME/android-sdk/platform-tools
        JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64
      run: |
        echo "Starting build with Android SDK path: $ANDROID_HOME"
        echo "Java home: $JAVA_HOME"
        
        # Первая попытка
        echo "=== BUILD ATTEMPT 1 ==="
        if buildozer -v android debug; then
          echo "✅ Build successful on first attempt"
          exit 0
        fi
        
        echo "First attempt failed. Cleaning and retrying..."
        buildozer android clean
        
        # Вторая попытка
        echo "=== BUILD ATTEMPT 2 ==="
        if buildozer -v android debug; then
          echo "✅ Build successful on second attempt"
          exit 0
        fi
        
        echo "Second attempt failed. Full cleanup..."
        rm -rf ~/.buildozer
        mkdir -p ~/.buildozer/android/platform
        
        # Третья попытка
        echo "=== BUILD ATTEMPT 3 ==="
        if buildozer -v android debug; then
          echo "✅ Build successful on third attempt"
          exit 0
        fi
        
        # Если все попытки провалились, показываем диагностическую информацию
        echo "❌ ALL BUILD ATTEMPTS FAILED"
        echo "Diagnostic information:"
        echo "SDK contents:"
        ls -la $ANDROID_HOME
        echo "Build-tools directory:"
        ls -la $ANDROID_HOME/build-tools
        echo "NDK directory:"
        ls -la $ANDROID_HOME/ndk
        echo "Last build log tail:"
        find ~/.buildozer -name "log" -exec tail -200 {} \; 2>/dev/null || echo "No logs found"
        exit 1
    
    - name: Find and upload APK
      run: |
        APK_FILE=$(find . -name "*.apk" -not -path "*build*" -type f | head -1)
        if [ -z "$APK_FILE" ]; then
          echo "❌ APK file not found!"
          echo "Search results:"
          find . -name "*.apk" -ls
          exit 1
        fi
        
        echo "✅ APK found at: $APK_FILE"
        mkdir -p artifacts
        cp "$APK_FILE" artifacts/ceiling_calculator.apk
        du -h artifacts/ceiling_calculator.apk
    
    - name: Upload result
      uses: actions/upload-artifact@v4
      with:
        name: ceiling-calculator-apk
        path: artifacts/ceiling_calculator.apk
        retention-days: 7
