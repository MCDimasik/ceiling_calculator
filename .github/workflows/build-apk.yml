name: Build APK - Working Version

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git openjdk-11-jdk python3-dev python3-pip zlib1g-dev libncurses5-dev libssl-dev libffi-dev
    
    - name: Install Buildozer
      run: |
        python -m pip install --upgrade pip
        pip install buildozer
        pip install cython
    
    - name: Create buildozer.spec
      run: |
        if [ ! -f buildozer.spec ]; then
          echo "[app]" > buildozer.spec
          echo "title = Ceiling Calculator" >> buildozer.spec
          echo "package.name = ceiling_calculator" >> buildozer.spec
          echo "package.domain = org.test" >> buildozer.spec
          echo "source.dir = ." >> buildozer.spec
          echo "source.include_exts = py,png,jpg,kv,ttf,db" >> buildozer.spec
          echo "version = 0.1" >> buildozer.spec
          echo "requirements = python3,kivy==2.1.0,kivymd==1.1.1,sqlite3,android,pillow==9.5.0" >> buildozer.spec
          echo "orientation = portrait" >> buildozer.spec
          echo "android.permissions = INTERNET,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE,ACCESS_NETWORK_STATE" >> buildozer.spec
          echo "android.archs = arm64-v8a" >> buildozer.spec
          echo "android.api = 33" >> buildozer.spec
          echo "android.minapi = 24" >> buildozer.spec
          echo "android.gradle_dependencies = com.google.android.material:material:1.8.0" >> buildozer.spec
          echo "android.enable_androidx = True" >> buildozer.spec
          echo "p4a.branch = master" >> buildozer.spec
          echo "android.sdk = 33" >> buildozer.spec
          echo "android.ndk = 25.1.8937393" >> buildozer.spec
          echo "debug = 1" >> buildozer.spec
          echo "" >> buildozer.spec
          echo "[buildozer]" >> buildozer.spec
          echo "log_level = 2" >> buildozer.spec
          echo "warn_on_root = 1" >> buildozer.spec
        fi
    
    - name: Accept Android licenses
      run: |
        mkdir -p ~/.android/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > ~/.android/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > ~/.android/licenses/android-sdk-preview-license
    
    - name: Build APK
      run: |
        echo "y" | buildozer android debug 2>&1 | tail -200
        
        mkdir -p artifacts
        if ls bin/*.apk 1>/dev/null 2>&1; then
          echo "APK built successfully!"
          cp bin/*.apk artifacts/ceiling_calculator.apk
          echo "apk_path=artifacts/ceiling_calculator.apk" >> $GITHUB_OUTPUT
        else
          echo "Build may have failed, trying to find APK..."
          find . -name "*.apk" -type f -exec cp {} artifacts/ceiling_calculator.apk \; 2>/dev/null || true
          if [ -f "artifacts/ceiling_calculator.apk" ]; then
            echo "Found APK!"
            echo "apk_path=artifacts/ceiling_calculator.apk" >> $GITHUB_OUTPUT
          else
            echo "No APK found!"
            exit 1
          fi
        fi
      id: build
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ceiling-calculator-apk
        path: ${{ steps.build.outputs.apk_path }}
        retention-days: 7
