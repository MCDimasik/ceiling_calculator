name: Build APK - Fixed Version

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.8
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'  # Python 3.8 более стабилен с Kivy
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip openjdk-8-jdk \
          python3-dev autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev \
          cmake libffi-dev libssl-dev \
          curl wget software-properties-common \
          build-essential patchelf \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          automake ninja-build \
          libxml2-dev libxslt1-dev \
          libjpeg-dev libpng-dev \
          libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
          libmtdev-dev \
          libudev-dev \
          swig gettext
    
    - name: Install Buildozer and Python packages
      run: |
        python -m pip install --upgrade pip
        pip install buildozer==1.4.0  # Более старая стабильная версия
        pip install cython==0.29.21
        pip install kivy==2.0.0  # Более старая версия Kivy
        pip install kivymd==0.104.2  # Совместимая версия KivyMD
        pip install pillow==8.3.2
    
    - name: Create buildozer.spec
      run: |
        if [ ! -f buildozer.spec ]; then
          echo "[app]" > buildozer.spec
          echo "title = Ceiling Calculator" >> buildozer.spec
          echo "package.name = ceiling_calculator" >> buildozer.spec
          echo "package.domain = org.test" >> buildozer.spec
          echo "source.dir = ." >> buildozer.spec
          echo "source.include_exts = py,png,jpg,kv,ttf,db" >> buildozer.spec
          echo "version = 0.1" >> buildozer.spec
          echo "requirements = python3,kivy==2.0.0,kivymd==0.104.2,android,pillow==8.3.2" >> buildozer.spec
          echo "orientation = portrait" >> buildozer.spec
          echo "android.permissions = INTERNET,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE,ACCESS_NETWORK_STATE" >> buildozer.spec
          echo "android.archs = arm64-v8a" >> buildozer.spec
          echo "android.api = 30" >> buildozer.spec  # Более низкий API
          echo "android.minapi = 21" >> buildozer.spec
          echo "android.gradle_dependencies = com.google.android.material:material:1.3.0" >> buildozer.spec
          echo "android.enable_androidx = True" >> buildozer.spec
          echo "p4a.branch = master" >> buildozer.spec
          echo "android.sdk = 30" >> buildozer.spec
          echo "android.ndk = 21.3.6528147" >> buildozer.spec  # Старая стабильная NDK
          echo "debug = 1" >> buildozer.spec
          echo "" >> buildozer.spec
          echo "[buildozer]" >> buildozer.spec
          echo "log_level = 2" >> buildozer.spec
          echo "warn_on_root = 1" >> buildozer.spec
        fi
    
    - name: Clean Buildozer cache
      run: |
        rm -rf ~/.buildozer
        mkdir -p ~/.buildozer
    
    - name: Initialize Buildozer
      run: |
        buildozer init 2>&1 | tail -20 || echo "Buildozer initialized"
    
    - name: Create Android SDK license file
      run: |
        mkdir -p ~/.android
        echo "### User Sources for Android SDK Manager" > ~/.android/repositories.cfg
        echo "count=0" >> ~/.android/repositories.cfg
    
    - name: Build APK
      env:
        JAVA_OPTS: "-Xmx4096M"
        GRADLE_OPTS: "-Dorg.gradle.daemon=false"
        BUILDOZER_ACCEPT_LICENSES: "yes"
        P4A_RELEASE_NDK_VERSION: "21.3.6528147"
      run: |
        echo "=== Starting Build ==="
        
        # Пытаемся собрать несколько раз
        for attempt in 1 2 3; do
          echo "=== Attempt $attempt ==="
          
          if [ $attempt -eq 2 ]; then
            echo "Cleaning build..."
            buildozer android clean
          fi
          
          if [ $attempt -eq 3 ]; then
            echo "Full clean..."
            rm -rf ~/.buildozer/android/platform
            rm -rf .buildozer
          fi
          
          # Запускаем сборку с автоматическим ответом на вопросы
          echo "y" | buildozer -v android debug 2>&1 | tee build_attempt_${attempt}.log
          
          # Проверяем успешность
          if grep -q "BUILD SUCCESSFUL" build_attempt_${attempt}.log || [ -n "$(find . -name '*.apk' -type f 2>/dev/null)" ]; then
            echo "Build successful on attempt $attempt"
            break
          else
            echo "Build failed on attempt $attempt"
            if [ $attempt -eq 3 ]; then
              echo "All attempts failed"
              echo "=== ERROR LOG ==="
              tail -200 build_attempt_${attempt}.log
              
              # Пробуем найти конкретную ошибку
              if grep -q "undeclared name not builtin: long" build_attempt_${attempt}.log; then
                echo "ERROR: Found 'long' type issue. Trying workaround..."
                # Попытка исправить проблему с long
                exit 1
              fi
            fi
          fi
        done
        
        # Ищем APK
        APK_FILE=$(find . -name "*.apk" -type f 2>/dev/null | head -1)
        if [ -z "$APK_FILE" ]; then
          APK_FILE=$(find bin -name "*.apk" -type f 2>/dev/null | head -1)
        fi
        
        if [ -n "$APK_FILE" ]; then
          echo "✅ APK found: $APK_FILE"
          mkdir -p artifacts
          cp "$APK_FILE" artifacts/ceiling_calculator.apk
          echo "apk_path=artifacts/ceiling_calculator.apk" >> $GITHUB_OUTPUT
        else
          echo "❌ APK not found!"
          echo "Searching for any APK files..."
          find . -name "*.apk" -ls 2>/dev/null || true
          exit 1
        fi
      id: build
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ceiling-calculator-apk
        path: ${{ steps.build.outputs.apk_path }}
        retention-days: 7
